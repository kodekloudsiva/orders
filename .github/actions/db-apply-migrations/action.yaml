name: "DB Apply Migrations"
description: "Apply EF Core migration SQL scripts to a database"

inputs:
  sql-host:
    description: "Database host"
    required: true
  sql-port:
    description: "Database port"
    required: true
  sql-db:
    description: "Database name"
    required: true
  sql-user:
    description: "Database user"
    required: true
  sql-pass:
    description: "Database password"
    required: true
  cicd-sql:
    description: "Path to cicd/sql directory"
    required: true
  runner-download-migrations:
    description: "migration script generated in previous job will be downloaded in this runner machines directory"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/download-artifact@v4
      with:
        name: db-migration-scripts
        path: ${{ inputs.runner-download-migrations }}
    

    - name: test file
      run | 
        echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-"
        pwd
        echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-"
        echo ${{ inputs.runner-download-migrations }}
        echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-"
        ls -lrta ${{ inputs.runner-download-migrations }}
        echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-"


    - name: Locate migration.sql
      id: find-sql
      shell: bash
      run: |
        echo "📂 Searching for migration.sql inside: ${{ inputs.runner-download-migrations }}"
        FOUND_FILE=$(find "${{ inputs.runner-download-migrations }}" -type f -name "migration.sql" | head -n 1)

        if [[ -z "$FOUND_FILE" ]]; then
          echo "❌ migration.sql not found in artifact!"
          exit 1
        fi

        echo "✅ Found migration.sql at: $FOUND_FILE"
        echo "MIGRATION_SQL=$FOUND_FILE" >> $GITHUB_ENV
        echo "migration-sql=$FOUND_FILE" >> $GITHUB_OUTPUT

    - name: Debug migration.sql path
      shell: bash
      run: |
        echo "Resolved migration.sql path: $MIGRATION_SQL"
        ls -lh "$MIGRATION_SQL"

    - name: Preview migration.sql (first 20 lines)
      shell: bash
      run: |
        echo "👀 Previewing first 20 lines of migration.sql:"
        head -n 20 "$MIGRATION_SQL" || echo "⚠️ Unable to read migration.sql"

    - name: Run SQL Applier to apply migration
      shell: bash
      run: |
        echo "🚀 Running SQL Applier with $MIGRATION_SQL"
        docker run --rm \
          -e DB_HOST="${{ inputs.sql-host }},${{ inputs.sql-port }}" \
          -e DB_NAME=${{ inputs.sql-db }} \
          -e DB_USER=${{ inputs.sql-user }} \
          -e DB_PASS="${{ inputs.sql-pass }}" \
          -v "${{ env.MIGRATION_SQL }}":/app/migration.sql \
          -v "${{ github.workspace }}/cicd/scripts/migration-entrypoint.sh":/app/migration-entrypoint.sh \
          mcr.microsoft.com/mssql-tools:latest \
          /bin/bash /app/migration-entrypoint.sh
